<!DOCTYPE html>
<html>
  <head>
    <title>WeChat Domain Verification Diagnosis</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
        margin: 0;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #ccc;
      }
      .success {
        background: #d4edda;
        border-left-color: #28a745;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        border-left-color: #ffc107;
        color: #856404;
      }
      .info {
        background: #d1ecf1;
        border-left-color: #17a2b8;
        color: #0c5460;
      }
      .test-button {
        background: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        transition: background 0.3s;
      }
      .test-button:hover {
        background: #0056b3;
      }
      .test-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
      }
      .url-display {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        word-break: break-all;
        border: 1px solid #dee2e6;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      h3 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .checklist {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }
      .checklist li {
        margin: 8px 0;
        padding: 5px 0;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-success {
        background: #28a745;
      }
      .status-error {
        background: #dc3545;
      }
      .status-warning {
        background: #ffc107;
      }
      .status-unknown {
        background: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç WeChat Authentication Diagnosis Tool</h1>

      <div class="section">
        <h3>Current Configuration</h3>
        <div class="info test-result">
          <p><strong>Domain:</strong> homefreshfoods.ai</p>
          <p><strong>App ID:</strong> wx4a71fe09bb125182</p>
          <p>
            <strong>Redirect URI:</strong>
            https://homefreshfoods.ai/wechat/callback
          </p>
          <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
          <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
          <p>
            <strong>WeChat Browser:</strong> <span id="isWeChatBrowser"></span>
          </p>
        </div>
      </div>

      <div class="section">
        <h3>üß™ Diagnostic Tests</h3>
        <button class="test-button" onclick="runAllTests()">
          üöÄ Run All Tests
        </button>
        <button class="test-button" onclick="testDomainAccess()">
          üåê Test Domain Access
        </button>
        <button class="test-button" onclick="testVerificationFile()">
          üìÑ Test Verification File
        </button>
        <button class="test-button" onclick="testSSLCertificate()">
          üîí Test SSL Certificate
        </button>
        <button class="test-button" onclick="testWeChatAuth()">
          üîó Generate WeChat Auth URL
        </button>
        <button class="test-button" onclick="generateQRCode()">
          üì± Generate QR Code
        </button>
        <button class="test-button" onclick="clearResults()">
          üóëÔ∏è Clear Results
        </button>
      </div>

      <div id="testResults"></div>

      <div class="section">
        <h3>üìã WeChat Developer Console Checklist</h3>
        <div class="checklist">
          <p>
            <strong
              >You MUST verify these in your WeChat Developer Console:</strong
            >
          </p>
          <ol>
            <li>
              <span class="status-indicator status-warning"></span>Login to
              <a href="https://developers.weixin.qq.com/" target="_blank"
                >WeChat Developer Console</a
              >
            </li>
            <li>
              <span class="status-indicator status-warning"></span>Navigate to:
              <strong>Development Configuration</strong> (ÂºÄÂèëÈÖçÁΩÆ) tab
            </li>
            <li>
              <span class="status-indicator status-error"></span>Find:
              <strong>Web Authorization Domain</strong> (ÁΩëÈ°µÊéàÊùÉÂüüÂêç) section
            </li>
            <li>
              <span class="status-indicator status-error"></span>Verify:
              <code>homefreshfoods.ai</code> is listed and
              <strong>verified</strong>
            </li>
            <li>
              <span class="status-indicator status-error"></span>Check:
              Verification file <code>MP_verify_*.txt</code> exists and
              accessible
            </li>
            <li>
              <span class="status-indicator status-error"></span>Ensure: Domain
              status shows as <strong>"Verified"</strong> or
              <strong>"Active"</strong>
            </li>
          </ol>
          <div class="error test-result">
            <strong>‚ö†Ô∏è Critical:</strong> If <code>homefreshfoods.ai</code> is
            NOT in the Web Authorization Domain list, you must add it and upload
            the verification file!
          </div>
        </div>
      </div>

      <div class="section">
        <h3>üì± Testing Instructions</h3>
        <div class="info test-result">
          <h4>Method 1: WeChat Browser Test</h4>
          <ol>
            <li>Open WeChat app on your phone</li>
            <li>Scan the QR code generated above OR</li>
            <li>Share this page to a WeChat chat and open it</li>
            <li>Click "Generate WeChat Auth URL" and test the link</li>
          </ol>

          <h4>Method 2: Chrome/Safari Test</h4>
          <ol>
            <li>Open this page in Chrome or Safari</li>
            <li>Run the diagnostic tests</li>
            <li>Check for verification file issues</li>
            <li>
              Note: External browsers will show different behavior than WeChat
              browser
            </li>
          </ol>
        </div>
      </div>

      <div class="section">
        <h3>üîß Expected Results</h3>
        <div class="warning test-result">
          <h4>If Domain is Properly Configured:</h4>
          <ul>
            <li>‚úÖ Domain access should succeed</li>
            <li>‚úÖ Verification file should be found</li>
            <li>‚úÖ SSL certificate should be valid</li>
            <li>‚úÖ WeChat auth should work in WeChat browser</li>
          </ul>

          <h4>If Getting Error 10003:</h4>
          <ul>
            <li>‚ùå Domain not in WeChat Console Web Authorization list</li>
            <li>‚ùå Verification file missing or incorrect</li>
            <li>‚ùå Domain not properly verified in WeChat Console</li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      // Initialize page
      document.getElementById("currentUrl").textContent = window.location.href;
      document.getElementById("userAgent").textContent = navigator.userAgent;
      document.getElementById("isWeChatBrowser").textContent =
        /micromessenger/i.test(navigator.userAgent) ? "‚úÖ Yes" : "‚ùå No";

      function addResult(message, type, id = null) {
        const div = document.createElement("div");
        div.className = `test-result ${type}`;
        div.innerHTML = message;
        if (id) div.id = id;
        document.getElementById("testResults").appendChild(div);

        // Scroll to results
        div.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      function clearResults() {
        document.getElementById("testResults").innerHTML = "";
      }

      async function testDomainAccess() {
        addResult(
          '<span class="loading"></span> Testing domain access...',
          "info",
          "domain-test"
        );

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);

          const response = await fetch("https://homefreshfoods.ai/", {
            method: "HEAD",
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          if (response.ok) {
            document.getElementById("domain-test").innerHTML =
              "‚úÖ <strong>Domain Access:</strong> homefreshfoods.ai is accessible";
            document.getElementById("domain-test").className =
              "test-result success";
          } else {
            document.getElementById(
              "domain-test"
            ).innerHTML = `‚ùå <strong>Domain Access Failed:</strong> HTTP ${response.status} - ${response.statusText}`;
            document.getElementById("domain-test").className =
              "test-result error";
          }
        } catch (error) {
          document.getElementById(
            "domain-test"
          ).innerHTML = `‚ùå <strong>Domain Access Error:</strong> ${error.message}`;
          document.getElementById("domain-test").className =
            "test-result error";
        }
      }

      async function testVerificationFile() {
        addResult(
          '<span class="loading"></span> Checking verification files...',
          "info",
          "verification-test"
        );

        const patterns = [
          "MP_verify_placeholder.txt",
          "MP_verify_wx4a71fe09bb125182.txt",
          "MP_verify_" + Date.now() + ".txt",
        ];

        let found = false;

        for (const pattern of patterns) {
          try {
            const response = await fetch(
              `https://homefreshfoods.ai/${pattern}`
            );
            if (response.ok) {
              const content = await response.text();
              document.getElementById(
                "verification-test"
              ).innerHTML = `‚úÖ <strong>Verification File Found:</strong> ${pattern}<br>
                            <strong>Content:</strong> <code>${content.substring(
                              0,
                              100
                            )}${content.length > 100 ? "..." : ""}</code>`;
              document.getElementById("verification-test").className =
                "test-result success";
              found = true;
              break;
            }
          } catch (e) {
            // Continue to next pattern
          }
        }

        if (!found) {
          document.getElementById(
            "verification-test"
          ).innerHTML = `‚ùå <strong>Verification File Missing:</strong> No MP_verify_*.txt file found<br>
                    <strong>Action Required:</strong> Download verification file from WeChat Developer Console and upload to website root`;
          document.getElementById("verification-test").className =
            "test-result error";
        }
      }

      async function testSSLCertificate() {
        addResult(
          '<span class="loading"></span> Testing SSL certificate...',
          "info",
          "ssl-test"
        );

        try {
          const response = await fetch("https://homefreshfoods.ai/", {
            method: "HEAD",
          });
          if (response.ok) {
            document.getElementById("ssl-test").innerHTML =
              "‚úÖ <strong>SSL Certificate:</strong> Valid HTTPS connection established";
            document.getElementById("ssl-test").className =
              "test-result success";
          } else {
            document.getElementById(
              "ssl-test"
            ).innerHTML = `‚ö†Ô∏è <strong>SSL Certificate:</strong> Connection established but got HTTP ${response.status}`;
            document.getElementById("ssl-test").className =
              "test-result warning";
          }
        } catch (error) {
          document.getElementById(
            "ssl-test"
          ).innerHTML = `‚ùå <strong>SSL Certificate Error:</strong> ${error.message}`;
          document.getElementById("ssl-test").className = "test-result error";
        }
      }

      function testWeChatAuth() {
        const state = "test_" + Math.random().toString(36).substring(7);
        const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx4a71fe09bb125182&redirect_uri=https%3A%2F%2Fhomefreshfoods.ai%2Fwechat%2Fcallback&response_type=code&scope=snsapi_base&state=${state}#wechat_redirect`;

        addResult(
          `üîó <strong>WeChat Auth URL Generated:</strong><br>
                <div class="url-display">${authUrl}</div>
                <p><strong>Test Instructions:</strong></p>
                <ol>
                    <li><a href="${authUrl}" target="_blank">Click here to test in new tab</a></li>
                    <li>If using WeChat browser, should proceed to authorization</li>
                    <li>If using external browser, may show error (this is expected)</li>
                    <li>If you get error 10003, domain is not properly configured in WeChat Console</li>
                </ol>`,
          "warning"
        );
      }

      function generateQRCode() {
        const state = "qr_" + Math.random().toString(36).substring(7);
        const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx4a71fe09bb125182&redirect_uri=https%3A%2F%2Fhomefreshfoods.ai%2Fwechat%2Fcallback&response_type=code&scope=snsapi_base&state=${state}#wechat_redirect`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(
          authUrl
        )}`;

        addResult(
          `üì± <strong>QR Code for WeChat Testing:</strong><br>
                <img src="${qrUrl}" alt="WeChat Auth QR Code" style="max-width: 300px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0;"><br>
                <p><strong>Instructions:</strong></p>
                <ol>
                    <li>Open WeChat app on your phone</li>
                    <li>Scan this QR code</li>
                    <li>Should open WeChat authorization page if domain is properly configured</li>
                    <li>If you get error 10003, check WeChat Developer Console configuration</li>
                </ol>
                <p><em>Note: QR code contains the WeChat OAuth URL for testing</em></p>`,
          "info"
        );
      }

      async function runAllTests() {
        clearResults();
        addResult(
          "üöÄ <strong>Running comprehensive diagnostics...</strong>",
          "info"
        );

        await testDomainAccess();
        await new Promise((resolve) => setTimeout(resolve, 1000)); // Small delay

        await testVerificationFile();
        await new Promise((resolve) => setTimeout(resolve, 1000));

        await testSSLCertificate();
        await new Promise((resolve) => setTimeout(resolve, 500));

        testWeChatAuth();

        addResult(
          `‚úÖ <strong>Diagnostic Complete!</strong><br>
                Review the results above. If you see any ‚ùå errors, those need to be fixed in your WeChat Developer Console.<br>
                <strong>Most Common Issue:</strong> Domain not added to Web Authorization Domain list in WeChat Console.`,
          "success"
        );
      }

      // Auto-run basic tests on page load
      window.onload = function () {
        setTimeout(() => {
          addResult(
            'üéØ <strong>Welcome to WeChat Diagnosis Tool!</strong><br>Click "Run All Tests" to start comprehensive testing.',
            "info"
          );
        }, 1000);
      };
    </script>
  </body>
</html>
